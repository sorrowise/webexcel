<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>投资管理人估值表处理工具</title>
    <!-- 思源宋体 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Claude 风格配色 */
            --bg-primary: #FAF9F7;
            --bg-secondary: #F5F4F0;
            --bg-card: #FFFFFF;
            --text-primary: #1A1915;
            --text-secondary: #5D5D5A;
            --text-muted: #8B8B88;
            --accent-primary: #D97706;
            --accent-secondary: #B45309;
            --accent-light: #FEF3C7;
            --border-color: #E5E4E0;
            --border-hover: #D1D0CC;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 12px 32px rgba(0, 0, 0, 0.08);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            
            /* 状态颜色 */
            --success-bg: #ECFDF5;
            --success-text: #065F46;
            --success-border: #A7F3D0;
            --warning-bg: #FFFBEB;
            --warning-text: #92400E;
            --warning-border: #FDE68A;
            --error-bg: #FEF2F2;
            --error-text: #991B1B;
            --error-border: #FECACA;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Serif SC', 'Source Han Serif SC', 'Source Han Serif', serif;
            background: var(--bg-primary);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* 顶部装饰条 */
        .top-accent {
            height: 3px;
            background: linear-gradient(90deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
        }

        .page-wrapper {
            max-width: 720px;
            margin: 0 auto;
            padding: 40px 24px 80px;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.9375rem;
            margin-bottom: 32px;
            transition: color 0.2s;
            cursor: pointer;
        }

        .back-link:hover {
            color: var(--accent-primary);
        }

        .back-link svg {
            width: 16px;
            height: 16px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 56px;
            height: 56px;
            background: var(--accent-light);
            border-radius: var(--radius-md);
            margin-bottom: 20px;
        }

        .header-icon svg {
            width: 28px;
            height: 28px;
            color: var(--accent-primary);
        }

        h1 {
            font-size: 1.875rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            letter-spacing: -0.02em;
        }

        .subtitle {
            font-size: 1rem;
            color: var(--text-secondary);
        }

        /* 上传区域 */
        .upload-area {
            background: var(--bg-card);
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-lg);
            padding: 48px 32px;
            text-align: center;
            margin-bottom: 24px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: var(--accent-primary);
            background: var(--accent-light);
        }

        .upload-area.dragover {
            border-color: var(--accent-primary);
            background: var(--accent-light);
            transform: scale(1.01);
        }

        .upload-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 64px;
            height: 64px;
            background: var(--bg-secondary);
            border-radius: 50%;
            margin-bottom: 20px;
            transition: all 0.2s;
        }

        .upload-area:hover .upload-icon {
            background: var(--accent-primary);
        }

        .upload-icon svg {
            width: 28px;
            height: 28px;
            color: var(--text-secondary);
            transition: color 0.2s;
        }

        .upload-area:hover .upload-icon svg {
            color: white;
        }

        .upload-text {
            font-size: 1.0625rem;
            color: var(--text-primary);
            margin-bottom: 8px;
            font-weight: 500;
        }

        .upload-hint {
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        #fileInput {
            display: none;
        }

        /* 文件列表 */
        .file-list {
            margin-bottom: 24px;
        }

        .file-item {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            padding: 16px 20px;
            border-radius: var(--radius-md);
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            min-width: 0;
        }

        .file-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            background: var(--accent-light);
            border-radius: var(--radius-sm);
            flex-shrink: 0;
        }

        .file-icon svg {
            width: 18px;
            height: 18px;
            color: var(--accent-primary);
        }

        .file-name {
            color: var(--text-primary);
            font-weight: 500;
            font-size: 0.9375rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-size {
            color: var(--text-muted);
            font-size: 0.8125rem;
            flex-shrink: 0;
            margin-left: 16px;
        }

        /* 按钮 */
        .btn {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
            font-weight: 600;
            box-shadow: var(--shadow-md);
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            background: var(--border-color);
            color: var(--text-muted);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-success {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }

        /* 进度条 */
        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--bg-secondary);
            border-radius: 3px;
            margin: 20px 0;
            overflow: hidden;
            display: none;
        }

        .progress-bar.show {
            display: block;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 3px;
        }

        /* 状态消息 */
        .status {
            padding: 16px 20px;
            border-radius: var(--radius-md);
            text-align: center;
            font-weight: 500;
            font-size: 0.9375rem;
            display: none;
            margin-top: 20px;
            border: 1px solid;
        }

        .status.loading {
            background: var(--warning-bg);
            color: var(--warning-text);
            border-color: var(--warning-border);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .status.success {
            background: var(--success-bg);
            color: var(--success-text);
            border-color: var(--success-border);
            display: block;
        }

        .status.error {
            background: var(--error-bg);
            color: var(--error-text);
            border-color: var(--error-border);
            display: block;
        }

        /* 加载动画 */
        .spinner {
            width: 18px;
            height: 18px;
            border: 2px solid var(--warning-border);
            border-top-color: var(--warning-text);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* 下载区域 */
        .download-section {
            margin-top: 32px;
            display: none;
        }

        .download-section.show {
            display: block;
        }

        .download-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .download-header-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background: var(--success-bg);
            border-radius: var(--radius-sm);
        }

        .download-header-icon svg {
            width: 20px;
            height: 20px;
            color: var(--success-text);
        }

        .download-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .download-link {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 16px 20px;
            border-radius: var(--radius-md);
            text-decoration: none;
            font-weight: 500;
            margin-bottom: 8px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .download-link:hover {
            border-color: var(--accent-primary);
            background: var(--accent-light);
        }

        .download-link svg {
            width: 20px;
            height: 20px;
            color: var(--accent-primary);
            flex-shrink: 0;
        }

        .download-link span {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #downloadAllBtn {
            margin-bottom: 16px;
        }

        @media (max-width: 768px) {
            .page-wrapper {
                padding: 24px 16px 60px;
            }

            h1 {
                font-size: 1.5rem;
            }

            .upload-area {
                padding: 32px 20px;
            }

            .file-item {
                padding: 12px 16px;
            }

            .btn {
                padding: 14px 24px;
            }
        }
    </style>
</head>
<body>
    <div class="top-accent"></div>
    
    <div class="page-wrapper">
        <a href="index.html" class="back-link">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
            </svg>
            返回首页
        </a>

        <div class="header">
            <div class="header-icon">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.375 19.5h17.25m-17.25 0a1.125 1.125 0 01-1.125-1.125M3.375 19.5h7.5c.621 0 1.125-.504 1.125-1.125m-9.75 0V5.625m0 12.75v-1.5c0-.621.504-1.125 1.125-1.125m18.375 2.625V5.625m0 12.75c0 .621-.504 1.125-1.125 1.125m1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125m0 3.75h-7.5A1.125 1.125 0 0112 18.375m9.75-12.75c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125m19.5 0v1.5c0 .621-.504 1.125-1.125 1.125M2.25 5.625v1.5c0 .621.504 1.125 1.125 1.125m0 0h17.25m-17.25 0h7.5c.621 0 1.125.504 1.125 1.125M3.375 8.25c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125m17.25-3.75h-7.5c-.621 0-1.125.504-1.125 1.125m8.625-1.125c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125m-17.25 0h7.5m-7.5 0c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125M12 10.875v-1.5m0 1.5c0 .621-.504 1.125-1.125 1.125M12 10.875c0 .621.504 1.125 1.125 1.125m-2.25 0c.621 0 1.125.504 1.125 1.125M13.125 12h7.5m-7.5 0c-.621 0-1.125.504-1.125 1.125M20.625 12c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125m-17.25 0h7.5M12 14.625v-1.5m0 1.5c0 .621-.504 1.125-1.125 1.125M12 14.625c0 .621.504 1.125 1.125 1.125m-2.25 0c.621 0 1.125.504 1.125 1.125m0 0v1.5c0 .621-.504 1.125-1.125 1.125m1.125-2.625c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125M12 18.375h7.5" />
                </svg>
            </div>
            <h1>投资管理人估值表处理工具</h1>
            <p class="subtitle">上传 Excel 文件，自动完成数据整理</p>
        </div>

        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
                </svg>
            </div>
            <div class="upload-text">点击或拖拽文件到此处上传</div>
            <div class="upload-hint">支持 .xlsx, .xls 格式</div>
            <input type="file" id="fileInput" multiple accept=".xlsx,.xls">
        </div>

        <div class="file-list" id="fileList"></div>

        <div class="progress-bar" id="progressBar">
            <div class="progress-fill" id="progressFill"></div>
        </div>

        <button class="btn" id="processBtn" disabled>开始处理</button>

        <div class="status" id="status"></div>

        <div class="download-section" id="downloadSection">
            <div class="download-header">
                <div class="download-header-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <div class="download-title">处理完成</div>
            </div>
            <button class="btn btn-success" id="downloadAllBtn" style="display: none;">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width: 20px; height: 20px; margin-right: 8px; vertical-align: middle;">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5m8.25 3v6.75m0 0l-3-3m3 3l3-3M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" />
                </svg>
                一键全部下载
            </button>
            <div id="downloadLinks"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script>
        let pyodide = null;
        let uploadedFiles = [];
        let processedFiles = [];

        // 初始化 Pyodide
        async function initPyodide() {
            const statusEl = document.getElementById('status');
            statusEl.className = 'status loading';
            statusEl.innerHTML = '<div class="spinner"></div><span>正在加载 Pyodide 环境...</span>';
            statusEl.style.display = 'flex';

            try {
                pyodide = await loadPyodide({
                    indexURL: "https://cdn.jsdelivr.net/pyodide/v0.24.1/full/"
                });

                // 安装 pandas、openpyxl 和 xlrd
                statusEl.innerHTML = '<div class="spinner"></div><span>正在安装依赖包...</span>';
                await pyodide.loadPackage(['micropip']);
                const micropip = pyodide.pyimport('micropip');
                
                // 先尝试使用 loadPackage 安装 xlrd（如果 Pyodide 内置了的话）
                try {
                    await pyodide.loadPackage('xlrd');
                    console.log('✓ xlrd 通过 loadPackage 安装成功');
                } catch (e) {
                    console.log('xlrd 不在 Pyodide 内置包中，将通过 micropip 安装');
                }
                
                // 安装必要的包
                await micropip.install(['pandas', 'openpyxl', 'xlrd']);
                
                // 验证安装
                pyodide.runPython(`
                    import pandas as pd
                    import openpyxl
                    try:
                        import xlrd
                        print(f"pandas 版本: {pd.__version__}")
                        print(f"openpyxl 版本: {openpyxl.__version__}")
                        print(f"xlrd 版本: {xlrd.__version__}")
                    except ImportError:
                        print("警告: xlrd 未正确安装")
                `);

                statusEl.className = 'status success';
                statusEl.textContent = '环境加载完成，可以开始处理文件';
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 2000);
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = '加载失败: ' + error.message;
            }
        }

        // 加载 Python 业务逻辑文件
        async function loadProcessScript() {
            let errorMessage = '';
            try {
                let logicLoaded = false;
                
                // 先加载 logic.py（如果存在）
                try {
                    console.log('正在加载 logic.py...');
                    const logicResponse = await fetch('logic.py');
                    console.log('logic.py 响应状态:', logicResponse.status, logicResponse.statusText);
                    
                    if (logicResponse.ok) {
                        const logicScript = await logicResponse.text();
                        console.log('logic.py 内容长度:', logicScript.length);
                        
                        try {
                            pyodide.FS.writeFile('logic.py', logicScript);
                            console.log('✓ logic.py 已写入文件系统');
                            
                            const fileInfo = pyodide.FS.analyzePath('logic.py');
                            if (fileInfo.exists) {
                                logicLoaded = true;
                                console.log('✓ logic.py 文件已确认存在');
                            } else {
                                throw new Error('logic.py 写入文件系统失败');
                            }
                        } catch (fsError) {
                            errorMessage = `将 logic.py 写入文件系统时出错: ${fsError.message || fsError.toString()}`;
                            console.error('写入 logic.py 失败:', fsError);
                            throw new Error(errorMessage);
                        }
                    } else {
                        console.warn('logic.py 不存在或无法访问 (HTTP ' + logicResponse.status + ')');
                    }
                } catch (logicError) {
                    console.error('logic.py 加载失败:', logicError);
                }
                
                // 然后加载 process.py
                console.log('正在加载 process.py...');
                const response = await fetch('process.py');
                console.log('process.py 响应状态:', response.status, response.statusText);
                
                if (!response.ok) {
                    errorMessage = `无法加载 process.py: HTTP ${response.status} ${response.statusText}`;
                    throw new Error(errorMessage);
                }
                
                const script = await response.text();
                console.log('process.py 内容长度:', script.length);
                
                if (script.includes('from logic import') || script.includes('import logic')) {
                    if (!logicLoaded) {
                        errorMessage = 'process.py 需要 logic.py，但 logic.py 加载失败。请确保 logic.py 文件与 process.py 在同一目录下。';
                        throw new Error(errorMessage);
                    }
                }
                
                try {
                    pyodide.runPython(script);
                    console.log('✓ process.py 加载并执行成功');
                    return { success: true };
                } catch (pyError) {
                    errorMessage = `执行 process.py 时出错: ${pyError.message || pyError.toString()}`;
                    console.error('执行 process.py 失败:', pyError);
                    try {
                        const pyErrorDetail = pyodide.runPython(`
                            import sys
                            import traceback
                            if hasattr(sys, 'last_value') and sys.last_value:
                                str(sys.last_value) + '\\n' + ''.join(traceback.format_exception(sys.last_type, sys.last_value, sys.last_traceback))
                            else:
                                None
                        `);
                        if (pyErrorDetail && pyErrorDetail.toString() !== 'None') {
                            errorMessage += '\n' + pyErrorDetail.toString();
                        }
                    } catch (e) {
                        console.warn('无法获取详细错误信息:', e);
                    }
                    throw new Error(errorMessage);
                }
            } catch (error) {
                console.error('加载 Python 脚本失败:', error);
                return { 
                    success: false, 
                    error: errorMessage || error.message || error.toString() 
                };
            }
        }

        // 文件上传处理
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const processBtn = document.getElementById('processBtn');

        uploadArea.addEventListener('click', () => fileInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        function handleFiles(files) {
            uploadedFiles = [];
            fileList.innerHTML = '';

            Array.from(files).forEach(file => {
                if (file.name.match(/\.(xlsx|xls)$/i)) {
                    uploadedFiles.push(file);
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.innerHTML = `
                        <div class="file-info">
                            <div class="file-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                                </svg>
                            </div>
                            <span class="file-name">${file.name}</span>
                        </div>
                        <span class="file-size">${formatFileSize(file.size)}</span>
                    `;
                    fileList.appendChild(fileItem);
                }
            });

            processBtn.disabled = uploadedFiles.length === 0 || !pyodide;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        // 处理文件
        processBtn.addEventListener('click', async () => {
            if (!pyodide || uploadedFiles.length === 0) return;

            const statusEl = document.getElementById('status');
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            const downloadSection = document.getElementById('downloadSection');
            const downloadLinks = document.getElementById('downloadLinks');

            // 重置状态
            downloadSection.classList.remove('show');
            downloadLinks.innerHTML = '';
            processedFiles = [];

            // 加载 Python 脚本
            statusEl.className = 'status loading';
            statusEl.innerHTML = '<div class="spinner"></div><span>正在加载处理脚本...</span>';
            statusEl.style.display = 'flex';

            const scriptResult = await loadProcessScript();
            if (!scriptResult.success) {
                statusEl.className = 'status error';
                statusEl.textContent = '加载处理脚本失败: ' + (scriptResult.error || '未知错误');
                statusEl.style.display = 'block';
                return;
            }

            progressBar.classList.add('show');
            processBtn.disabled = true;

            try {
                for (let i = 0; i < uploadedFiles.length; i++) {
                    const file = uploadedFiles[i];
                    const progress = ((i + 1) / uploadedFiles.length) * 100;
                    progressFill.style.width = progress + '%';

                    statusEl.innerHTML = `<div class="spinner"></div><span>正在处理: ${file.name} (${i + 1}/${uploadedFiles.length})</span>`;

                    // 读取文件为 ArrayBuffer
                    const arrayBuffer = await file.arrayBuffer();
                    const uint8Array = new Uint8Array(arrayBuffer);

                    // 清理文件名，避免特殊字符问题
                    const safeFileName = file.name.replace(/[^a-zA-Z0-9._-]/g, '_');
                    
                    // 将文件数据传递给 Python
                    pyodide.FS.writeFile(safeFileName, uint8Array);

                    // 调用 Python 处理函数
                    let outputFileName;
                    try {
                        pyodide.runPython(`
                            import sys
                            import traceback
                            import os
                            _process_result = None
                            _process_error = None
                            try:
                                original_name = r'${file.name.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"')}'
                                result = process_excel(r'${safeFileName.replace(/\\/g, '\\\\').replace(/'/g, "\\'")}', original_name=original_name)
                                if not os.path.exists(result):
                                    raise Exception(f"处理完成但输出文件不存在: {result}")
                                _process_result = result
                            except KeyError as e:
                                try:
                                    df_temp = pd.read_excel(r'${safeFileName.replace(/\\/g, '\\\\').replace(/'/g, "\\'")}')
                                    available_cols = list(df_temp.columns)
                                    error_msg = f"列不存在错误: {str(e)}\\n可用列名: {available_cols}"
                                except:
                                    error_msg = f"列不存在错误: {str(e)}"
                                _process_error = error_msg
                            except OSError as e:
                                error_msg = f"文件系统错误 (errno {e.errno}): {str(e)}\\n{traceback.format_exc()}"
                                _process_error = error_msg
                            except Exception as e:
                                error_msg = f"{str(e)}\\n{traceback.format_exc()}"
                                _process_error = error_msg
                        `);
                        
                        const processError = pyodide.runPython('_process_error if "_process_error" in globals() and _process_error is not None else None');
                        if (processError && processError.toString() !== 'None') {
                            throw new Error(processError.toString());
                        }
                        
                        const resultPath = pyodide.runPython('_process_result if "_process_result" in globals() and _process_result is not None else None');
                        if (!resultPath || resultPath.toString() === 'None') {
                            throw new Error('处理函数未返回文件路径');
                        }
                        
                        outputFileName = String(resultPath);
                        console.log('输出文件名:', outputFileName);
                    } catch (error) {
                        try {
                            pyodide.FS.unlink(safeFileName);
                        } catch (e) {}
                        
                        let errorMsg = '';
                        
                        if (error.name === 'ErrnoError' || error.errno !== undefined) {
                            errorMsg = `文件系统错误 (errno: ${error.errno || '未知'}): ${error.message || error.toString()}`;
                        } else if (error.message) {
                            errorMsg = error.message;
                        } else {
                            errorMsg = error.toString();
                        }
                        
                        console.error('处理错误详情:', error);
                        throw new Error(errorMsg);
                    }

                    if (!outputFileName || outputFileName === 'undefined' || outputFileName === 'None') {
                        throw new Error('无法获取输出文件名，处理可能失败');
                    }
                    
                    let fileExists = false;
                    try {
                        const fileInfo = pyodide.FS.analyzePath(outputFileName);
                        fileExists = fileInfo.exists;
                    } catch (e) {
                        fileExists = false;
                    }
                    
                    if (!fileExists) {
                        throw new Error(`输出文件 ${outputFileName} 不存在，文件保存可能失败`);
                    }
                    
                    let outputData;
                    try {
                        outputData = pyodide.FS.readFile(outputFileName);
                    } catch (e) {
                        throw new Error(`读取输出文件失败: ${e.message}`);
                    }
                    
                    const blob = new Blob([outputData], { 
                        type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
                    });

                    const url = URL.createObjectURL(blob);
                    processedFiles.push({
                        originalName: file.name,
                        outputName: outputFileName,
                        url: url
                    });

                    try {
                        pyodide.FS.unlink(safeFileName);
                        if (outputFileName && pyodide.FS.analyzePath(outputFileName).exists) {
                            pyodide.FS.unlink(outputFileName);
                        }
                    } catch (e) {
                        console.warn('清理临时文件失败:', e);
                    }
                }

                // 显示下载链接
                downloadLinks.innerHTML = processedFiles.map((file, index) => {
                    const displayName = file.outputName || `processed_${file.originalName}`;
                    return `
                        <a href="${file.url}" download="${displayName}" class="download-link">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                            </svg>
                            <span>${displayName}</span>
                        </a>
                    `;
                }).join('');

                const downloadAllBtn = document.getElementById('downloadAllBtn');
                if (processedFiles.length > 1) {
                    downloadAllBtn.style.display = 'block';
                    downloadAllBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width: 20px; height: 20px; margin-right: 8px; vertical-align: middle;">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5m8.25 3v6.75m0 0l-3-3m3 3l3-3M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" />
                        </svg>
                        一键全部下载 (${processedFiles.length} 个文件)
                    `;
                } else {
                    downloadAllBtn.style.display = 'none';
                }

                downloadSection.classList.add('show');
                progressBar.classList.remove('show');
                statusEl.className = 'status success';
                statusEl.textContent = `处理完成！共处理 ${uploadedFiles.length} 个文件`;

                uploadedFiles = [];
                fileList.innerHTML = '';
                fileInput.value = '';
                processBtn.disabled = false;

            } catch (error) {
                progressBar.classList.remove('show');
                statusEl.className = 'status error';
                statusEl.textContent = '处理失败: ' + (error.message || error.toString() || '未知错误');
                statusEl.style.display = 'block';
                console.error('处理错误:', error);
                processBtn.disabled = false;
                
                uploadedFiles.forEach(file => {
                    const safeFileName = file.name.replace(/[^a-zA-Z0-9._-]/g, '_');
                    try {
                        if (pyodide.FS.analyzePath(safeFileName).exists) {
                            pyodide.FS.unlink(safeFileName);
                        }
                    } catch (e) {}
                });
            }
        });

        // 一键全部下载功能
        const downloadAllBtn = document.getElementById('downloadAllBtn');
        downloadAllBtn.addEventListener('click', async () => {
            if (processedFiles.length === 0) {
                alert('没有可下载的文件');
                return;
            }

            try {
                downloadAllBtn.disabled = true;
                downloadAllBtn.innerHTML = `
                    <div class="spinner" style="width: 18px; height: 18px; border-color: rgba(255,255,255,0.3); border-top-color: white; margin-right: 8px; display: inline-block; vertical-align: middle;"></div>
                    正在打包...
                `;

                const zip = new JSZip();

                for (let i = 0; i < processedFiles.length; i++) {
                    const file = processedFiles[i];
                    const displayName = file.outputName || `processed_${file.originalName}`;
                    const response = await fetch(file.url);
                    const blob = await response.blob();
                    zip.file(displayName, blob);
                }

                const zipBlob = await zip.generateAsync({ 
                    type: 'blob',
                    compression: 'DEFLATE',
                    compressionOptions: { level: 6 }
                });

                const zipUrl = URL.createObjectURL(zipBlob);
                const zipLink = document.createElement('a');
                zipLink.href = zipUrl;
                zipLink.download = `processed_files_${new Date().getTime()}.zip`;
                document.body.appendChild(zipLink);
                zipLink.click();
                document.body.removeChild(zipLink);
                
                setTimeout(() => {
                    URL.revokeObjectURL(zipUrl);
                }, 100);

                downloadAllBtn.disabled = false;
                downloadAllBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width: 20px; height: 20px; margin-right: 8px; vertical-align: middle;">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5m8.25 3v6.75m0 0l-3-3m3 3l3-3M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" />
                    </svg>
                    一键全部下载 (${processedFiles.length} 个文件)
                `;
            } catch (error) {
                console.error('打包失败:', error);
                alert('打包失败: ' + error.message);
                downloadAllBtn.disabled = false;
                downloadAllBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width: 20px; height: 20px; margin-right: 8px; vertical-align: middle;">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5m8.25 3v6.75m0 0l-3-3m3 3l3-3M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" />
                    </svg>
                    一键全部下载
                `;
            }
        });

        // 页面加载时初始化
        window.addEventListener('load', () => {
            initPyodide().then(() => {
                processBtn.disabled = uploadedFiles.length === 0;
            });
        });
    </script>
</body>
</html>
