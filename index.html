<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ•èµ„ç®¡ç†äººä¼°å€¼è¡¨å¤„ç†å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            /* font-family:'Times New Roman', æ¥·ä½“_GB2312, serif; */
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: #f8f9ff;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }

        .upload-area.dragover {
            border-color: #764ba2;
            background: #e8ebff;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 1.2em;
            color: #667eea;
            margin-bottom: 10px;
        }

        .upload-hint {
            color: #999;
            font-size: 0.9em;
        }

        #fileInput {
            display: none;
        }

        .file-list {
            margin-top: 20px;
        }

        .file-item {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-name {
            flex: 1;
            color: #333;
            font-weight: 500;
        }

        .file-size {
            color: #999;
            font-size: 0.9em;
            margin-left: 15px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
            margin-top: 20px;
            font-weight: 600;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-weight: 500;
            display: none;
        }

        .status.loading {
            background: #fff3cd;
            color: #856404;
            display: block;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            display: block;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            display: block;
        }

        .download-section {
            margin-top: 20px;
            display: none;
        }

        .download-section.show {
            display: block;
        }

        .download-link {
            display: block;
            background: #28a745;
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            text-decoration: none;
            font-weight: 600;
            margin-top: 10px;
            transition: background 0.3s;
        }

        .download-link:hover {
            background: #218838;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
            display: none;
        }

        .progress-bar.show {
            display: block;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š æŠ•èµ„ç®¡ç†äººä¼°å€¼è¡¨å¤„ç†å·¥å…·</h1>

        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">ğŸ“</div>
            <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½ä¼°å€¼è¡¨ Excel æ–‡ä»¶åˆ°æ­¤å¤„</div>
            <div class="upload-hint">æ”¯æŒ .xlsx, .xls æ ¼å¼</div>
            <input type="file" id="fileInput" multiple accept=".xlsx,.xls">
        </div>

        <div class="file-list" id="fileList"></div>

        <div class="progress-bar" id="progressBar">
            <div class="progress-fill" id="progressFill"></div>
        </div>

        <button class="btn" id="processBtn" disabled>å¼€å§‹å¤„ç†</button>

        <div class="status" id="status"></div>

        <div class="download-section" id="downloadSection">
            <h3 style="margin-top: 20px; color: #333;">å¤„ç†å®Œæˆï¼</h3>
            <button class="btn" id="downloadAllBtn" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); margin-bottom: 15px; display: none;">
                ğŸ“¦ ä¸€é”®å…¨éƒ¨ä¸‹è½½
            </button>
            <div id="downloadLinks"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script>
        let pyodide = null;
        let uploadedFiles = [];
        let processedFiles = [];

        // åˆå§‹åŒ– Pyodide
        async function initPyodide() {
            const statusEl = document.getElementById('status');
            statusEl.className = 'status loading';
            statusEl.textContent = 'æ­£åœ¨åŠ è½½ Pyodide ç¯å¢ƒ...';
            statusEl.style.display = 'block';

            try {
                pyodide = await loadPyodide({
                    indexURL: "https://cdn.jsdelivr.net/pyodide/v0.24.1/full/"
                });

                // å®‰è£… pandasã€openpyxl å’Œ xlrd
                statusEl.textContent = 'æ­£åœ¨å®‰è£… pandasã€openpyxl å’Œ xlrd...';
                await pyodide.loadPackage(['micropip']);
                const micropip = pyodide.pyimport('micropip');
                
                // å…ˆå°è¯•ä½¿ç”¨ loadPackage å®‰è£… xlrdï¼ˆå¦‚æœ Pyodide å†…ç½®äº†çš„è¯ï¼‰
                try {
                    await pyodide.loadPackage('xlrd');
                    console.log('âœ“ xlrd é€šè¿‡ loadPackage å®‰è£…æˆåŠŸ');
                } catch (e) {
                    console.log('xlrd ä¸åœ¨ Pyodide å†…ç½®åŒ…ä¸­ï¼Œå°†é€šè¿‡ micropip å®‰è£…');
                }
                
                // å®‰è£…å¿…è¦çš„åŒ…
                // xlrd ç”¨äºè¯»å– .xls æ–‡ä»¶ï¼ˆæ—§ç‰ˆ Excel æ ¼å¼ï¼‰
                // openpyxl ç”¨äºè¯»å–å’Œå†™å…¥ .xlsx æ–‡ä»¶ï¼ˆæ–°ç‰ˆ Excel æ ¼å¼ï¼‰
                await micropip.install(['pandas', 'openpyxl', 'xlrd']);
                
                // éªŒè¯å®‰è£…
                pyodide.runPython(`
                    import pandas as pd
                    import openpyxl
                    try:
                        import xlrd
                        print(f"pandas ç‰ˆæœ¬: {pd.__version__}")
                        print(f"openpyxl ç‰ˆæœ¬: {openpyxl.__version__}")
                        print(f"xlrd ç‰ˆæœ¬: {xlrd.__version__}")
                    except ImportError:
                        print("è­¦å‘Š: xlrd æœªæ­£ç¡®å®‰è£…")
                `);

                statusEl.className = 'status success';
                statusEl.textContent = 'âœ“ Pyodide ç¯å¢ƒåŠ è½½å®Œæˆï¼';
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 2000);
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = 'åŠ è½½å¤±è´¥: ' + error.message;
            }
        }

        // åŠ è½½ Python ä¸šåŠ¡é€»è¾‘æ–‡ä»¶
        async function loadProcessScript() {
            let errorMessage = '';
            try {
                let logicLoaded = false;
                
                // å…ˆåŠ è½½ logic.pyï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                try {
                    console.log('æ­£åœ¨åŠ è½½ logic.py...');
                    const logicResponse = await fetch('logic.py');
                    console.log('logic.py å“åº”çŠ¶æ€:', logicResponse.status, logicResponse.statusText);
                    
                    if (logicResponse.ok) {
                        const logicScript = await logicResponse.text();
                        console.log('logic.py å†…å®¹é•¿åº¦:', logicScript.length);
                        
                        // å°† logic.py å†™å…¥åˆ° Pyodide æ–‡ä»¶ç³»ç»Ÿï¼Œä½¿å…¶å¯ä»¥ä½œä¸ºæ¨¡å—å¯¼å…¥
                        try {
                            // å†™å…¥åˆ°å½“å‰å·¥ä½œç›®å½•ï¼Œè¿™æ · Python å¯ä»¥æ‰¾åˆ°å®ƒ
                            pyodide.FS.writeFile('logic.py', logicScript);
                            console.log('âœ“ logic.py å·²å†™å…¥æ–‡ä»¶ç³»ç»Ÿ');
                            
                            // éªŒè¯æ–‡ä»¶æ˜¯å¦å­˜åœ¨
                            const fileInfo = pyodide.FS.analyzePath('logic.py');
                            if (fileInfo.exists) {
                                logicLoaded = true;
                                console.log('âœ“ logic.py æ–‡ä»¶å·²ç¡®è®¤å­˜åœ¨');
                            } else {
                                throw new Error('logic.py å†™å…¥æ–‡ä»¶ç³»ç»Ÿå¤±è´¥');
                            }
                        } catch (fsError) {
                            errorMessage = `å°† logic.py å†™å…¥æ–‡ä»¶ç³»ç»Ÿæ—¶å‡ºé”™: ${fsError.message || fsError.toString()}`;
                            console.error('å†™å…¥ logic.py å¤±è´¥:', fsError);
                            throw new Error(errorMessage);
                        }
                    } else {
                        console.warn('logic.py ä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—® (HTTP ' + logicResponse.status + ')');
                    }
                } catch (logicError) {
                    console.error('logic.py åŠ è½½å¤±è´¥:', logicError);
                    // æ£€æŸ¥ process.py æ˜¯å¦éœ€è¦ logic.py
                    // å…ˆä¸æŠ›å‡ºé”™è¯¯ï¼Œç­‰æ£€æŸ¥ process.py åå†å†³å®š
                }
                
                // ç„¶ååŠ è½½ process.py
                console.log('æ­£åœ¨åŠ è½½ process.py...');
                const response = await fetch('process.py');
                console.log('process.py å“åº”çŠ¶æ€:', response.status, response.statusText);
                
                if (!response.ok) {
                    errorMessage = `æ— æ³•åŠ è½½ process.py: HTTP ${response.status} ${response.statusText}`;
                    throw new Error(errorMessage);
                }
                
                const script = await response.text();
                console.log('process.py å†…å®¹é•¿åº¦:', script.length);
                
                // æ£€æŸ¥è„šæœ¬ä¸­æ˜¯å¦å¯¼å…¥äº† logic
                if (script.includes('from logic import') || script.includes('import logic')) {
                    if (!logicLoaded) {
                        errorMessage = 'process.py éœ€è¦ logic.pyï¼Œä½† logic.py åŠ è½½å¤±è´¥ã€‚è¯·ç¡®ä¿ logic.py æ–‡ä»¶ä¸ process.py åœ¨åŒä¸€ç›®å½•ä¸‹ã€‚';
                        throw new Error(errorMessage);
                    }
                }
                
                // æ‰§è¡Œ process.py
                try {
                    pyodide.runPython(script);
                    console.log('âœ“ process.py åŠ è½½å¹¶æ‰§è¡ŒæˆåŠŸ');
                    return { success: true };
                } catch (pyError) {
                    errorMessage = `æ‰§è¡Œ process.py æ—¶å‡ºé”™: ${pyError.message || pyError.toString()}`;
                    console.error('æ‰§è¡Œ process.py å¤±è´¥:', pyError);
                    // å°è¯•è·å–æ›´è¯¦ç»†çš„ Python é”™è¯¯ä¿¡æ¯
                    try {
                        const pyErrorDetail = pyodide.runPython(`
                            import sys
                            import traceback
                            if hasattr(sys, 'last_value') and sys.last_value:
                                str(sys.last_value) + '\\n' + ''.join(traceback.format_exception(sys.last_type, sys.last_value, sys.last_traceback))
                            else:
                                None
                        `);
                        if (pyErrorDetail && pyErrorDetail.toString() !== 'None') {
                            errorMessage += '\n' + pyErrorDetail.toString();
                        }
                    } catch (e) {
                        console.warn('æ— æ³•è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯:', e);
                    }
                    throw new Error(errorMessage);
                }
            } catch (error) {
                console.error('åŠ è½½ Python è„šæœ¬å¤±è´¥:', error);
                return { 
                    success: false, 
                    error: errorMessage || error.message || error.toString() 
                };
            }
        }

        // æ–‡ä»¶ä¸Šä¼ å¤„ç†
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const processBtn = document.getElementById('processBtn');

        uploadArea.addEventListener('click', () => fileInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        function handleFiles(files) {
            uploadedFiles = [];
            fileList.innerHTML = '';

            Array.from(files).forEach(file => {
                if (file.name.match(/\.(xlsx|xls)$/i)) {
                    uploadedFiles.push(file);
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.innerHTML = `
                        <span class="file-name">${file.name}</span>
                        <span class="file-size">${formatFileSize(file.size)}</span>
                    `;
                    fileList.appendChild(fileItem);
                }
            });

            processBtn.disabled = uploadedFiles.length === 0 || !pyodide;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        // å¤„ç†æ–‡ä»¶
        processBtn.addEventListener('click', async () => {
            if (!pyodide || uploadedFiles.length === 0) return;

            const statusEl = document.getElementById('status');
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            const downloadSection = document.getElementById('downloadSection');
            const downloadLinks = document.getElementById('downloadLinks');

            // é‡ç½®çŠ¶æ€
            downloadSection.classList.remove('show');
            downloadLinks.innerHTML = '';
            processedFiles = [];

            // åŠ è½½ Python è„šæœ¬
            statusEl.className = 'status loading';
            statusEl.textContent = 'æ­£åœ¨åŠ è½½å¤„ç†è„šæœ¬...';
            statusEl.style.display = 'block';

            const scriptResult = await loadProcessScript();
            if (!scriptResult.success) {
                statusEl.className = 'status error';
                statusEl.textContent = 'åŠ è½½å¤„ç†è„šæœ¬å¤±è´¥: ' + (scriptResult.error || 'æœªçŸ¥é”™è¯¯');
                statusEl.style.display = 'block';
                return;
            }

            progressBar.classList.add('show');
            processBtn.disabled = true;

            try {
                for (let i = 0; i < uploadedFiles.length; i++) {
                    const file = uploadedFiles[i];
                    const progress = ((i + 1) / uploadedFiles.length) * 100;
                    progressFill.style.width = progress + '%';

                    statusEl.textContent = `æ­£åœ¨å¤„ç†: ${file.name} (${i + 1}/${uploadedFiles.length})`;

                    // è¯»å–æ–‡ä»¶ä¸º ArrayBuffer
                    const arrayBuffer = await file.arrayBuffer();
                    const uint8Array = new Uint8Array(arrayBuffer);

                    // æ¸…ç†æ–‡ä»¶åï¼Œé¿å…ç‰¹æ®Šå­—ç¬¦é—®é¢˜
                    const safeFileName = file.name.replace(/[^a-zA-Z0-9._-]/g, '_');
                    
                    // å°†æ–‡ä»¶æ•°æ®ä¼ é€’ç»™ Python
                    pyodide.FS.writeFile(safeFileName, uint8Array);

                    // è°ƒç”¨ Python å¤„ç†å‡½æ•°
                    let outputFileName;
                    try {
                        // å…ˆæ‰§è¡Œå¤„ç†ï¼Œå°†ç»“æœå­˜å‚¨åˆ°å…¨å±€å˜é‡
                        pyodide.runPython(`
                            import sys
                            import traceback
                            import os
                            _process_result = None
                            _process_error = None
                            try:
                                # ä¼ é€’åŸå§‹æ–‡ä»¶åä»¥ä¿ç•™ä¸­æ–‡
                                original_name = r'${file.name.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"')}'
                                result = process_excel(r'${safeFileName.replace(/\\/g, '\\\\').replace(/'/g, "\\'")}', original_name=original_name)
                                # éªŒè¯ç»“æœæ–‡ä»¶æ˜¯å¦å­˜åœ¨
                                if not os.path.exists(result):
                                    raise Exception(f"å¤„ç†å®Œæˆä½†è¾“å‡ºæ–‡ä»¶ä¸å­˜åœ¨: {result}")
                                _process_result = result
                            except KeyError as e:
                                # è¯»å–æ–‡ä»¶è·å–åˆ—å
                                try:
                                    df_temp = pd.read_excel(r'${safeFileName.replace(/\\/g, '\\\\').replace(/'/g, "\\'")}')
                                    available_cols = list(df_temp.columns)
                                    error_msg = f"åˆ—ä¸å­˜åœ¨é”™è¯¯: {str(e)}\\nå¯ç”¨åˆ—å: {available_cols}"
                                except:
                                    error_msg = f"åˆ—ä¸å­˜åœ¨é”™è¯¯: {str(e)}"
                                _process_error = error_msg
                            except OSError as e:
                                error_msg = f"æ–‡ä»¶ç³»ç»Ÿé”™è¯¯ (errno {e.errno}): {str(e)}\\n{traceback.format_exc()}"
                                _process_error = error_msg
                            except Exception as e:
                                error_msg = f"{str(e)}\\n{traceback.format_exc()}"
                                _process_error = error_msg
                        `);
                        
                        // æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯
                        const processError = pyodide.runPython('_process_error if "_process_error" in globals() and _process_error is not None else None');
                        if (processError && processError.toString() !== 'None') {
                            throw new Error(processError.toString());
                        }
                        
                        // è·å–ç»“æœ
                        const resultPath = pyodide.runPython('_process_result if "_process_result" in globals() and _process_result is not None else None');
                        if (!resultPath || resultPath.toString() === 'None') {
                            throw new Error('å¤„ç†å‡½æ•°æœªè¿”å›æ–‡ä»¶è·¯å¾„');
                        }
                        
                        // ç¡®ä¿æ­£ç¡®è½¬æ¢ Python å­—ç¬¦ä¸²ï¼ˆæ”¯æŒä¸­æ–‡ï¼‰
                        outputFileName = String(resultPath);
                        console.log('è¾“å‡ºæ–‡ä»¶å:', outputFileName);
                        console.log('æ–‡ä»¶åé•¿åº¦:', outputFileName.length);
                    } catch (error) {
                        // æ¸…ç†ä¸´æ—¶æ–‡ä»¶
                        try {
                            pyodide.FS.unlink(safeFileName);
                        } catch (e) {}
                        
                        // æå–é”™è¯¯ä¿¡æ¯
                        let errorMsg = '';
                        
                        // å¤„ç† Pyodide çš„ ErrnoError
                        if (error.name === 'ErrnoError' || error.errno !== undefined) {
                            errorMsg = `æ–‡ä»¶ç³»ç»Ÿé”™è¯¯ (errno: ${error.errno || 'æœªçŸ¥'}): ${error.message || error.toString()}`;
                            if (error.errno === 44) {
                                errorMsg += '\nè¿™å¯èƒ½æ˜¯æ–‡ä»¶ä¿å­˜æ—¶çš„é—®é¢˜ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶è·¯å¾„å’Œæƒé™ã€‚';
                            }
                        } else if (error.message) {
                            errorMsg = error.message;
                        } else {
                            errorMsg = error.toString();
                        }
                        
                        // å°è¯•ä» Python è·å–æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
                        try {
                            const pyError = pyodide.runPython(`
                                try:
                                    import sys
                                    if hasattr(sys, 'last_value') and sys.last_value:
                                        str(sys.last_value)
                                    else:
                                        None
                                except:
                                    None
                            `);
                            if (pyError && pyError.toString() !== 'None') {
                                errorMsg = pyError.toString() + '\n' + errorMsg;
                            }
                        } catch (e) {
                            // å¦‚æœè·å–å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹é”™è¯¯ä¿¡æ¯
                        }
                        
                        console.error('å¤„ç†é”™è¯¯è¯¦æƒ…:', error);
                        throw new Error(errorMsg);
                    }

                    // éªŒè¯ outputFileName æ˜¯å¦å·²è®¾ç½®
                    if (!outputFileName || outputFileName === 'undefined' || outputFileName === 'None') {
                        throw new Error('æ— æ³•è·å–è¾“å‡ºæ–‡ä»¶åï¼Œå¤„ç†å¯èƒ½å¤±è´¥');
                    }
                    
                    // æ£€æŸ¥è¾“å‡ºæ–‡ä»¶æ˜¯å¦å­˜åœ¨
                    let fileExists = false;
                    try {
                        const fileInfo = pyodide.FS.analyzePath(outputFileName);
                        fileExists = fileInfo.exists;
                        console.log(`æ£€æŸ¥æ–‡ä»¶ ${outputFileName}: å­˜åœ¨=${fileExists}`);
                    } catch (e) {
                        console.error('æ£€æŸ¥æ–‡ä»¶æ—¶å‡ºé”™:', e);
                        fileExists = false;
                    }
                    
                    if (!fileExists) {
                        // å°è¯•åˆ—å‡ºå½“å‰ç›®å½•çš„æ–‡ä»¶ï¼Œå¸®åŠ©è°ƒè¯•
                        try {
                            const files = pyodide.runPython(`
                                import os
                                [f for f in os.listdir('.') if f.endswith('.xlsx')]
                            `);
                            console.log('å½“å‰ç›®å½•çš„ xlsx æ–‡ä»¶:', files);
                        } catch (e) {
                            console.error('åˆ—å‡ºæ–‡ä»¶å¤±è´¥:', e);
                        }
                        throw new Error(`è¾“å‡ºæ–‡ä»¶ ${outputFileName} ä¸å­˜åœ¨ï¼Œæ–‡ä»¶ä¿å­˜å¯èƒ½å¤±è´¥`);
                    }
                    
                    // è¯»å–å¤„ç†åçš„æ–‡ä»¶
                    let outputData;
                    try {
                        outputData = pyodide.FS.readFile(outputFileName);
                    } catch (e) {
                        throw new Error(`è¯»å–è¾“å‡ºæ–‡ä»¶å¤±è´¥: ${e.message}`);
                    }
                    
                    const blob = new Blob([outputData], { 
                        type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
                    });

                    // åˆ›å»ºä¸‹è½½é“¾æ¥
                    const url = URL.createObjectURL(blob);
                    processedFiles.push({
                        originalName: file.name,
                        outputName: outputFileName, // æ–‡ä»¶åå·²åŒ…å«ä¸­æ–‡
                        url: url
                    });

                    // æ¸…ç†ä¸´æ—¶æ–‡ä»¶
                    try {
                        pyodide.FS.unlink(safeFileName);
                        if (outputFileName && pyodide.FS.analyzePath(outputFileName).exists) {
                            pyodide.FS.unlink(outputFileName);
                        }
                    } catch (e) {
                        console.warn('æ¸…ç†ä¸´æ—¶æ–‡ä»¶å¤±è´¥:', e);
                    }
                }

                // æ˜¾ç¤ºä¸‹è½½é“¾æ¥
                downloadLinks.innerHTML = processedFiles.map((file, index) => {
                    const displayName = file.outputName || `processed_${file.originalName}`;
                    // å¯¹ä¸­æ–‡æ–‡ä»¶åè¿›è¡Œç¼–ç å¤„ç†ï¼Œç¡®ä¿æ­£ç¡®æ˜¾ç¤ºå’Œä¸‹è½½
                    const encodedName = encodeURIComponent(displayName);
                    // ä½¿ç”¨ data URL æ–¹å¼ç¡®ä¿ä¸­æ–‡æ–‡ä»¶åæ­£ç¡®ä¸‹è½½
                    return `
                        <a href="${file.url}" download="${displayName}" class="download-link" data-filename="${displayName}">
                            ğŸ“¥ ä¸‹è½½: ${displayName}
                        </a>
                    `;
                }).join('');

                // è®¾ç½®ä¸€é”®å…¨éƒ¨ä¸‹è½½æŒ‰é’®ï¼ˆåªæœ‰å¤šä¸ªæ–‡ä»¶æ—¶æ‰æ˜¾ç¤ºï¼‰
                const downloadAllBtn = document.getElementById('downloadAllBtn');
                if (processedFiles.length > 1) {
                    downloadAllBtn.style.display = 'block';
                    downloadAllBtn.textContent = `ğŸ“¦ ä¸€é”®å…¨éƒ¨ä¸‹è½½ (${processedFiles.length} ä¸ªæ–‡ä»¶)`;
                } else {
                    downloadAllBtn.style.display = 'none';
                }

                downloadSection.classList.add('show');
                progressBar.classList.remove('show');
                statusEl.className = 'status success';
                statusEl.textContent = `âœ“ å¤„ç†å®Œæˆï¼å…±å¤„ç† ${uploadedFiles.length} ä¸ªæ–‡ä»¶`;

                // æ¸…ç©ºæ–‡ä»¶åˆ—è¡¨
                uploadedFiles = [];
                fileList.innerHTML = '';
                fileInput.value = '';
                processBtn.disabled = false;

            } catch (error) {
                progressBar.classList.remove('show');
                statusEl.className = 'status error';
                let errorMessage = 'å¤„ç†å¤±è´¥: ';
                if (error.message) {
                    errorMessage += error.message;
                } else if (error.toString) {
                    errorMessage += error.toString();
                } else {
                    errorMessage += 'æœªçŸ¥é”™è¯¯';
                }
                statusEl.textContent = errorMessage;
                statusEl.style.display = 'block';
                console.error('å¤„ç†é”™è¯¯:', error);
                processBtn.disabled = false;
                
                // æ¸…ç†æ‰€æœ‰ä¸´æ—¶æ–‡ä»¶
                uploadedFiles.forEach(file => {
                    const safeFileName = file.name.replace(/[^a-zA-Z0-9._-]/g, '_');
                    try {
                        if (pyodide.FS.analyzePath(safeFileName).exists) {
                            pyodide.FS.unlink(safeFileName);
                        }
                    } catch (e) {
                        console.warn('æ¸…ç†æ–‡ä»¶å¤±è´¥:', e);
                    }
                });
            }
        });

        // ä¸€é”®å…¨éƒ¨ä¸‹è½½åŠŸèƒ½
        const downloadAllBtn = document.getElementById('downloadAllBtn');
        downloadAllBtn.addEventListener('click', async () => {
            if (processedFiles.length === 0) {
                alert('æ²¡æœ‰å¯ä¸‹è½½çš„æ–‡ä»¶');
                return;
            }

            try {
                downloadAllBtn.disabled = true;
                downloadAllBtn.textContent = 'ğŸ“¦ æ­£åœ¨æ‰“åŒ…...';

                // åˆ›å»º JSZip å®ä¾‹
                const zip = new JSZip();

                // å°†æ‰€æœ‰æ–‡ä»¶æ·»åŠ åˆ° zip
                for (let i = 0; i < processedFiles.length; i++) {
                    const file = processedFiles[i];
                    const displayName = file.outputName || `processed_${file.originalName}`;
                    
                    // ä» blob URL è·å–æ–‡ä»¶æ•°æ®
                    const response = await fetch(file.url);
                    const blob = await response.blob();
                    
                    // æ·»åŠ åˆ° zip
                    zip.file(displayName, blob);
                }

                // ç”Ÿæˆ zip æ–‡ä»¶
                const zipBlob = await zip.generateAsync({ 
                    type: 'blob',
                    compression: 'DEFLATE',
                    compressionOptions: { level: 6 }
                });

                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const zipUrl = URL.createObjectURL(zipBlob);
                const zipLink = document.createElement('a');
                zipLink.href = zipUrl;
                zipLink.download = `processed_files_${new Date().getTime()}.zip`;
                document.body.appendChild(zipLink);
                zipLink.click();
                document.body.removeChild(zipLink);
                
                // æ¸…ç† URL
                setTimeout(() => {
                    URL.revokeObjectURL(zipUrl);
                }, 100);

                downloadAllBtn.disabled = false;
                downloadAllBtn.textContent = 'ğŸ“¦ ä¸€é”®å…¨éƒ¨ä¸‹è½½';
            } catch (error) {
                console.error('æ‰“åŒ…å¤±è´¥:', error);
                alert('æ‰“åŒ…å¤±è´¥: ' + error.message);
                downloadAllBtn.disabled = false;
                downloadAllBtn.textContent = 'ğŸ“¦ ä¸€é”®å…¨éƒ¨ä¸‹è½½';
            }
        });

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', () => {
            initPyodide().then(() => {
                processBtn.disabled = uploadedFiles.length === 0;
            });
        });
    </script>
</body>
</html>
